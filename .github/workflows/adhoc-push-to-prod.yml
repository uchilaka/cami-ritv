name: Ad-hoc Push to Production

on:
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'Deployment message'
        required: true
        default: 'Ad-hoc deployment to production'
      git_ref:
        type: choice
        required: true
        description: 'Git reference (branch, tag, or commit SHA) to deploy'
        default: 'releases/production'
        options:
          - 'releases/production'
          - 'releases/staging'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    permissions:
      contents: read
      deployments: write

    strategy:
      fail-fast: true
      matrix:
        ruby-version: [3.4]
        node-version: [22.x]

    env:
      RAILS_ENV: production
      WORKFLOW_REF: ${{ github.ref }}
      DEPLOY_TARGET_REF: refs/heads/${{ github.event.inputs.git_ref }}

    steps:
    - name: Checkout workflow branch
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}

    - name: Check ruby version
      run: ruby -v

    - uses: actions/cache@v4
      with:
        path: vendor/bundle
        key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-gems-

    - name: Check workflow git ref
      run: |
        echo "Workflow Git Ref: $WORKFLOW_REF"

    - name: Checkout deploy branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.git_ref }}

    - name: Deploy ${{ env.WORKFLOW_REF }} to ${{ github.event.inputs.git_ref }}
      env:
        DEPLOY_MESSAGE: ${{ github.event.inputs.deploy_message }}
      run: |
        # Replace the following command with your actual deployment command/script
        echo "Deploying to production with message: $DEPLOY_MESSAGE"
        # Example deployment command:
        # bundle exec cap production deploy MESSAGE="$DEPLOY_MESSAGE"
        #
        # Merge the ref into the releases/production branch and push
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git merge $WORKFLOW_REF -m "Merge workflow SHA for deployment"
        # Push the checked out branch back to origin
        git push origin ${{ github.event.inputs.git_ref }}
